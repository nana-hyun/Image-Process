# 8.5. Intensity-based methods

image intensity : point 나 surface feature에 대한 대안적인 registration basis

-> most widely used registration basis

"intensity" : image pixel or voxel의 스칼라 값

pixel 또는 voxel 값의 물리적 의미 : registration 양식에 따라 다르다.

optimal power의 직접적인 측정이 아닌 경우ㅏㄱ 많다.

Intensity-based registraiton  : pixel or voxel 값만 단독으로 사용하는 두개의 이미지 사이의 변환 계산을 포함

purest form : 모든 pixel 또는 voxel 값에서 계산되는 유사성 측정(similarity measure)을 반복적으로 최적화 하여 결정

-> 의료 영상에서는 3차원 이미지가 우세 ( voxel similarity measures)

* intensity-based registration algoritm : voxel의 하위집합만 사용 , 일종의 전처리 과정이 필요

voxel의 하위 집합만 사용 ? : 알고리즘을 더 빠르게 실행. 하위 집합(subset) - 일반 그리드 or randomly  선택

이러한 상황에서는 하위 이미지에서 aliasing 방지 위해서 샘플링 전에 이미지를 흐리게 하는 것이 일반적이나 사용되는 흐리게 하는 양은 응용에 따라 다르다.

* 대안적으로는 모든 voxel이 아닌, 이미지의 정의된 관심 영역에 있는 voxel에서 유사성 측정 값이 계산되는 경우에만 알고리즘이 안정적으로 작동 가능

-> 이 경우, 이미지의 사전 분할(pre-segmentation)이 필요하다. registration 되는 양식과 연구되는 신체 부위 모두에 따라 달라질 수 있다.

* 일부 다른 intensity-based algorithm에서 유사성 측정은 원래 voxel 값이 아닌, image gradient 와 같은 파생된 이미지 parameter에서 작동

* retrospective registration) intensity-based registration은 전처리의 양이나 요구되는 사용자 상호작용의 양이 point-based / surface-based 보다 훨씬 적다.

-> 자동화 하기 쉽다

전처리의 필요성은 많은 강도 기반 알고리즘은 상당히 제한된 범위의 이미지로 제한된다는 의미

최근 연구의 목표 : application 별 사전 처리 없이 다양한 이미지 유형에서 작동하는 일반적인 알고리즘 고안

-----

intensity-based registiration algorithm : 매우 다양한 응용분야에 사용 가능

- 동일 / 다른 차원의 image registration
- 왜곡을 포함하는 rigid transformation and registration
- intermodality / intramodality

대부분의 알고리즘은 이러한 응용 프로그램의 하위 집합에만 적용 가능 / 일부 알고리즘은 상당히 일반적으로 적용

algorithm  - 반복적 -> 유사성 측정값 최적화 (section 8.5.2)

*표기법*

* regist 할 image A, B
* 이 이미지의 voxel 집합 {A(i)},{B(i)}
* A : reference image로 다룸
* B : registration 변환 T의 연속적인 추정치에 의해 B' = T(B)로 반복적으로 변환되는 영상으로 처리

변환 추정치는 registration 중인 이미지 사이의 중첩을 변하게 할 것


**voxel similarity measure**

A와 B'의 중첩 영역, 즉 ![image](https://user-images.githubusercontent.com/101063108/169710506-62b82bf0-e7c5-4b29-9579-f4e7c5a40d27.png)
내에서의 voxel 집합에 대해 항상 계산되며, 이는 T의 함수이고 알고리즘이 반복될 때마다 변한다.


일부 voxel similarity의 경우 히스토그램 정보가 사용되므로, 인덱스 voxel이 아닌, 이미지의 intensity 값 직접 참조한다.

의료 영상 : voxel 당 10 bits(1024 values), 12 bits(4096 values), 16 bits(655636 values) intensity 정보를 가진다.

intensity 정보를 사용하는 많은 알고리즘은 voxle 값을 더 적은 수의 파티션(64, 128, 256)으로 그룹화

image A와 B의 intensity 파티션 set : {a}, {b}

intensity 파티션 수 : Na, Nb

voxel intensity 범위는 T에 따라 달라지기 때문에 {b}는 T의 함수일 수도 있다.


## 8.5.1. Similarity Measures
### 8.5.1.1. Image subtraction

registration 되는 이미지 A와 B가 오정렬을 제외하고 동일하다고 가정

-> 유사도 측정값 = sum of squares of intensity differences (SSD)

* 이미지가 올바르게 정렬 : SSD=0
* SSD는 misregistration과 registration 에러에 따라 증가

특정 이미지 registration 문제 : 이상적인 케이스에 상당히 가까움

* MR image의 serial registration에서 정렬되는 이미지는 질병의 진행이나 치료에 대한 반응으로 발생할 수 있는 작은 변화를 제외하고는 동일할 것으로 예상
* fMR 실험 : 연구 중 소수의 voxel 만 변경될 것으로 예상 -> 연구 중 환자의 움직임 수정위해 registration하는 모든 image가 서로 유사
* -> 정렬되는 voxel의 작은 부분만 이미지 획득 간에 변경되었을 가능 성이 있는 경우 SSD가 잘 작동한다

데이터가 이상적인 경우에서 너무 많이 벗어나면 이 접근 방식이 실패할 수 있다.

ex) 적은 수의 voxel이 강도 intensity를 크게 변경하면, 제공강도 차이의 변화에 큰 영향

-> registration 전에 이미지의 일부를 미리 분할하는 것이 바람직, 이 전처리는 일반적으로 두피가 변형될 수 있는 serial MR 뇌 registration을 수행할 때 두피에 대해 수행한다.

의료 영상에서, Gaussian noise 가정이 자주 깨지는데, MR magnitude images : 이미지 고강도 부분에서만 대략 가우시안을 따르고, 저강도에서는 가우시안과 거리가 멀다.

![image](https://user-images.githubusercontent.com/101063108/169710938-14153773-b52b-4efd-8c29-1a53db9b3291.png)

### 8.5.1.2. Correlation Coefficient

이미지 A와 B의 강도가 선형적으로 관련되어 있으면 correlation coefficient CC 가 이상적인 유사성 척도로 표시 될 수 있다.

이 요구사항을 정확히 준수하는 registration 응용 프로그램은 거의 없지만, 많은 intra modality 응용이 유용한 측정이 되기에 충분히 근접한다.

![image](https://user-images.githubusercontent.com/101063108/169711286-e1faaca3-3650-42b1-b8e7-7d145b5276b5.png)

### 8.5.1.3. Variance of intensity ratios

SSD, CC : intramodality registration에만 적합하다

*Woods가 Varience of Intensity Ration measure을 제안 (VIR)*

* 서로 다른 PET 뇌 이미지 registration
* MR과 PET 뇌이미지 registration
* serial MR image에도 널리 사용된다.

multimodality registration algorithm : 특정 MR 픽셀 값을 가진, 모든 픽셀이 동일한 조직유형을 나타내므로 해당 PET 픽셀의 값도 서로 유사해야한다는 이상적인 가정을 가진다.

Algorithm :  각 MR Intensity 값 (또는 partitioned intensity value)에 대한 PET voxel 값의 정규화 표준편차를 최소화

VIR : 히스토그램 관점에서 유용

MR image에서 각각의 intensity partition "a"에 대해 이 파티션 내에서 intensity를 갖는 MR image volume은 전체에 분포된 ![image](https://user-images.githubusercontent.com/101063108/169711541-1192e656-e6ee-4b8a-ad82-60099b55e887.png)
voxel이 있다.

registration 변환의 주어진 추정치 T에 대해 이러한 MR voxel과 같은 위치에 있는 ![image](https://user-images.githubusercontent.com/101063108/169711568-a1690502-4953-4c31-abf9-0b997c1f01c9.png)
PET voxel이 있다. PET voxel의 intensity -> 히스토그램으로 표시가능

* 모든 파티션에 대한 히스토그램의 확산을 최소화하는 변환 T를 찾는 것을 목표로 한다.

각 파티션의 히스토그램이 uni-modal 이 아니면 알고리즘이 실패할 수 있다.

머리의 MR-PET registration and serial image 

: 전처리 - 경막 외 조직 제거

-> bimodal/trimodal 히스토그램을 피하는데 도움

분할 프로세스는 상대적으로 조잡할 수 있다.

![image](https://user-images.githubusercontent.com/101063108/169711654-05758df5-46f0-496a-a368-ac2b4ba4291c.png)

VIR 최소화를 위해 T를 구함

![image](https://user-images.githubusercontent.com/101063108/169711665-efbb674e-97e7-473a-b507-f9481fd2a155.png)

* ![image](https://user-images.githubusercontent.com/101063108/169711670-2f3d20d6-2027-49a8-94fc-c5e10c8c8c1a.png)
: 강도가 a인 image A의 voxel의 수

* ![image](https://user-images.githubusercontent.com/101063108/169711700-4767c0f2-253a-4c0b-91d4-7d00cd20bc52.png)
and ![image](https://user-images.githubusercontent.com/101063108/169711713-d0afd6a2-f3c8-44c6-8d16-60b1afb40e8f.png)
: A의 파티션 a에 강도가 있는 voxel과 함께 발생하는 이미지 B'의 voxel의 평균 및 표준편차

* N : ![image](https://user-images.githubusercontent.com/101063108/169711736-2b044f80-c4b2-4096-aec9-1e5fb9520cad.png)
의 voxel의 수

A <-> B / a <-> b 이어도 VIR 대체값 계산 가능.

VIR 값은 다르고, VIR 측정 선택 application에 따라 다르다.

Intramodality registration : 각 파티션은 하나의 강도 값으로 구성

MR-PET registration : 256개의 intensivity 파티션

### 8.5.1.4. Joint histograms and joint probability distributions

**joint histogram**

: 올바르게 정렬된 2개의 이미지로 구성

ex. the first and second echo images from spin-echo acquistion

: n 차원 ( n : 이를 생성하는데 사용된 이미지의 수)

* 축 :  각 이미지의 강도 (또는 강도 파티션)
* 각 지점의 값 : 특정 intensity  조합을 가진 voxel의 수
* normalized => n개의 이미지에서 intensity의 probability distribution function (PDF)의 추정치

![image](https://user-images.githubusercontent.com/101063108/169712247-7056fcd8-7c45-407a-8e70-6c2c79dc2a68.png)


for many image modality combination, PDF changes with T

![image](https://user-images.githubusercontent.com/101063108/169712750-0ca9ca43-bac4-4e44-a344-a5abf7c3abe2.png)


T -> PDF change는 질적으로 유사하다 for many modality combinations

### 8.5.1.5. Joint entropy

Shannon entropy H : 정보의 척도. 확률 {P(s)}를 가지는 {s} 의 집합에 의해 제공되는 평균 정보

![image](https://user-images.githubusercontent.com/101063108/169712326-0767565d-387a-48d2-8c9a-51296d498d72.png)

s의 확률이 모두 같으면, 엔트로피가 최대가 된다. 

한 symbol의 확률이 1이고 나머지는 0일때 엔트로피는 최소가 된다. 

이미지 registration을 위한 엔트로피 및 기타 정보 이론적인 측정의 사용은 joint histogram 및 PDF 검사 후에 나타남

이미지가 올바르게 정렬되면, joint histogram은 큰 어두운 영역으로 둘러싸인 tight한 cluster를 가진다.

cluster : 이미지가 덜 registration -> 분산,

어두운 영역 : 확률이 0

cluster 분산 -> joint histogram 고강도 영역이 덜 강렬(확률 감소), 어두운 영역은 더 밝아짐(0 또는 매우 낮은 확률의 히스토그램 항목이 더 적다)

잘못 registration-> histogram entropy 증가

이미지 A와 B' 에서 계산된 PDF의 엔트로피는 이미지 registration 위해서 반복적으로 최소화를 한다.

**VIR 최소화**

-> 이미지 A의 각 강도 분할에 대해 이미지 B'의 voxel histogram 확산을 최소화해준다.

histogram이 unimodal일 경우, 확산이 최소화 되며 엔트로피도 최소화된다.

joint entropy 측정은 VIR보다 두가지 이점을 가진다.

1. cluster의 확산을 1차원이 아닌 2차원으로 최소화
2. entropy 최소화 이해 히스토그램이 분산을 최소화하는 방식과 같이 unimodal일 필요가 없다.

-> VIR보다 multimodality registration에 일반적인 적용이 가능하다. bimodal histogram 피하기 위해 이미지 일부를 분할할 필요가 없다.

![image](https://user-images.githubusercontent.com/101063108/169712760-5bfcd73d-55c0-42c4-a1e2-0dc868bbc785.png)


### 8.5.1.6. Mutual information

엔트로피 최소화 : 모든 유형의 이미지 registration에 대한 강력한 voxel 유사도 측정은 아니다. 

joint entropy는 두 이미지가 겹치는 영역에서만 정의

강도값의 범위와 분포는 T (다른 영상과 겹치는 부분)

The change in overlap with T can lead to histogram changes that mask the clustering effects described above

-> 엔트로피 H 대신 정보이론적인 측정 상호정보 (MI)를 사용한다.

MI : 기여하는 신호의 부분 엔트로피와 관련하여 joint entropy 정규화, 이미지 registration과 관련하여 이 측정을 T가 있는 이미지 A와 B' 의 intensity histogram 변화를 고려해야한다.

![image](https://user-images.githubusercontent.com/101063108/169712864-0d7288dc-dfbe-4cb1-86a0-b9fc13fc18ef.png)

![image](https://user-images.githubusercontent.com/101063108/169712868-792fc370-15ec-4afe-a1af-940c587e7654.png)


### 8.5.1.7. Normalization of mutual information

상호정보는 joint entropy의 많은 단점을 극복, 일부 유형의 임상 이미지, 특히 대상 외부 주변에 많은 양의 air(noise)를 포함하는 ㅣㅇ미지에서 여전히 실패할 수 있다.

다양한 정규화를 통해 상호정보의 향상된 성능을 얻을 수 있다.

알고리즘은 의료영상을 실험 통해 얻은 것으로, 발견적 기원이라 할 수 있다.

상호 정보와 몇몇 case에서 잘 수행된다.

## 8.5.2. 








