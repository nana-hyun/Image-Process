# 8.5. Intensity-based methods

image intensity : point 나 surface feature에 대한 대안적인 registration basis

-> most widely used registration basis

"intensity" : image pixel or voxel의 스칼라 값

pixel 또는 voxel 값의 물리적 의미 : registration 양식에 따라 다르다.

optimal power의 직접적인 측정이 아닌 경우ㅏㄱ 많다.

Intensity-based registraiton  : pixel or voxel 값만 단독으로 사용하는 두개의 이미지 사이의 변환 계산을 포함

purest form : 모든 pixel 또는 voxel 값에서 계산되는 유사성 측정(similarity measure)을 반복적으로 최적화 하여 결정

-> 의료 영상에서는 3차원 이미지가 우세 ( voxel similarity measures)

* intensity-based registration algoritm : voxel의 하위집합만 사용 , 일종의 전처리 과정이 필요

voxel의 하위 집합만 사용 ? : 알고리즘을 더 빠르게 실행. 하위 집합(subset) - 일반 그리드 or randomly  선택

이러한 상황에서는 하위 이미지에서 aliasing 방지 위해서 샘플링 전에 이미지를 흐리게 하는 것이 일반적이나 사용되는 흐리게 하는 양은 응용에 따라 다르다.

* 대안적으로는 모든 voxel이 아닌, 이미지의 정의된 관심 영역에 있는 voxel에서 유사성 측정 값이 계산되는 경우에만 알고리즘이 안정적으로 작동 가능

-> 이 경우, 이미지의 사전 분할(pre-segmentation)이 필요하다. registration 되는 양식과 연구되는 신체 부위 모두에 따라 달라질 수 있다.

* 일부 다른 intensity-based algorithm에서 유사성 측정은 원래 voxel 값이 아닌, image gradient 와 같은 파생된 이미지 parameter에서 작동

* retrospective registration) intensity-based registration은 전처리의 양이나 요구되는 사용자 상호작용의 양이 point-based / surface-based 보다 훨씬 적다.

-> 자동화 하기 쉽다

전처리의 필요성은 많은 강도 기반 알고리즘은 상당히 제한된 범위의 이미지로 제한된다는 의미

최근 연구의 목표 : application 별 사전 처리 없이 다양한 이미지 유형에서 작동하는 일반적인 알고리즘 고안

-----

intensity-based registiration algorithm : 매우 다양한 응용분야에 사용 가능

- 동일 / 다른 차원의 image registration
- 왜곡을 포함하는 rigid transformation and registration
- intermodality / intramodality

대부분의 알고리즘은 이러한 응용 프로그램의 하위 집합에만 적용 가능 / 일부 알고리즘은 상당히 일반적으로 적용

algorithm  - 반복적 -> 유사성 측정값 최적화 (section 8.5.2)

*표기법*

* regist 할 image A, B
* 이 이미지의 voxel 집합 {A(i)},{B(i)}
* A : reference image로 다룸
* B : registration 변환 T의 연속적인 추정치에 의해 B' = T(B)로 반복적으로 변환되는 영상으로 처리

변환 추정치는 registration 중인 이미지 사이의 중첩을 변하게 할 것


**voxel similarity measure**

A와 B'의 중첩 영역, 즉 ![image](https://user-images.githubusercontent.com/101063108/169710506-62b82bf0-e7c5-4b29-9579-f4e7c5a40d27.png)
내에서의 voxel 집합에 대해 항상 계산되며, 이는 T의 함수이고 알고리즘이 반복될 때마다 변한다.


일부 voxel similarity의 경우 히스토그램 정보가 사용되므로, 인덱스 voxel이 아닌, 이미지의 intensity 값 직접 참조한다.

의료 영상 : voxel 당 10 bits(1024 values), 12 bits(4096 values), 16 bits(655636 values) intensity 정보를 가진다.

intensity 정보를 사용하는 많은 알고리즘은 voxle 값을 더 적은 수의 파티션(64, 128, 256)으로 그룹화

image A와 B의 intensity 파티션 set : {a}, {b}

intensity 파티션 수 : Na, Nb

voxel intensity 범위는 T에 따라 달라지기 때문에 {b}는 T의 함수일 수도 있다.


## 8.5.1. Similarity Measures
### 8.5.1.1. Image subtraction

registration 되는 이미지 A와 B가 오정렬을 제외하고 동일하다고 가정

-> 유사도 측정값 = sum of squares of intensity differences (SSD)

* 이미지가 올바르게 정렬 : SSD=0
* SSD는 misregistration과 registration 에러에 따라 증가

특정 이미지 registration 문제 : 이상적인 케이스에 상당히 가까움

* MR image의 serial registration에서 정렬되는 이미지는 질병의 진행이나 치료에 대한 반응으로 발생할 수 있는 작은 변화를 제외하고는 동일할 것으로 예상
* fMR 실험 : 연구 중 소수의 voxel 만 변경될 것으로 예상 -> 연구 중 환자의 움직임 수정위해 registration하는 모든 image가 서로 유사
* -> 정렬되는 voxel의 작은 부분만 이미지 획득 간에 변경되었을 가능 성이 있는 경우 SSD가 잘 작동한다

데이터가 이상적인 경우에서 너무 많이 벗어나면 이 접근 방식이 실패할 수 있다.

ex) 적은 수의 voxel이 강도 intensity를 크게 변경하면, 제공강도 차이의 변화에 큰 영향

-> registration 전에 이미지의 일부를 미리 분할하는 것이 바람직, 이 전처리는 일반적으로 두피가 변형될 수 있는 serial MR 뇌 registration을 수행할 때 두피에 대해 수행한다.

의료 영상에서, Gaussian noise 가정이 자주 깨지는데, MR magnitude images : 이미지 고강도 부분에서만 대략 가우시안을 따르고, 저강도에서는 가우시안과 거리가 멀다.

![image](https://user-images.githubusercontent.com/101063108/169710938-14153773-b52b-4efd-8c29-1a53db9b3291.png)

### 8.5.1.2. Correlation Coefficient

이미지 A와 B의 강도가 선형적으로 관련되어 있으면 correlation coefficient CC 가 이상적인 유사성 척도로 표시 될 수 있다.

이 요구사항을 정확히 준수하는 registration 응용 프로그램은 거의 없지만, 많은 intra modality 응용이 유용한 측정이 되기에 충분히 근접한다.

![image](https://user-images.githubusercontent.com/101063108/169711286-e1faaca3-3650-42b1-b8e7-7d145b5276b5.png)

### 8.5.1.3. Variance of intensity ratios

SSD, CC : intramodality registration에만 적합하다

*Woods가 Varience of Intensity Ration measure을 제안 (VIR) *

* 서로 다른 PET 뇌 이미지 registration
* MR과 PET 뇌이미지 registration
* serial MR image에도 널리 사용된다.

multimodality registration algorithm : 특정 MR 픽셀 값을 가진, 모든 픽셀이 동일한 조직유형을 나타내므로 해당 PET 픽셀의 값도 서로 유사해야한다는 이상적인 가정을 가진다.

Algorithm :  각 MR Intensity 값 (또는 partitioned intensity value)에 대한 PET voxel 값의 정규화 표준편차를 최소화

VIR : 히스토그램 관점에서 유용

MR image에서 각각의 intensity partition "a"에 대해 이 파티션 내에서 intensity를 갖는 MR image volume은 전체에 분포된 ![image](https://user-images.githubusercontent.com/101063108/169711541-1192e656-e6ee-4b8a-ad82-60099b55e887.png)
voxel이 있다.

registration 변환의 주어진 추정치 T에 대해 이러한 MR voxel과 같은 위치에 있는 ![image](https://user-images.githubusercontent.com/101063108/169711568-a1690502-4953-4c31-abf9-0b997c1f01c9.png)
PET voxel이 있다. PET voxel의 intensity -> 히스토그램으로 표시가능

* 모든 파티션에 대한 히스토그램의 확산을 최소화하는 변환 T를 찾는 것을 목표로 한다.

각 파티션의 히스토그램이 uni-modal 이 아니면 알고리즘이 실패할 수 있다.

머리의 MR-PET registration and serial image 

: 전처리 - 경막 외 조직 제거

-> bimodal/trimodal 히스토그램을 피하는데 도움

분할 프로세스는 상대적으로 조잡할 수 있다.

![image](https://user-images.githubusercontent.com/101063108/169711654-05758df5-46f0-496a-a368-ac2b4ba4291c.png)

VIR 최소화를 위해 T를 구함

![image](https://user-images.githubusercontent.com/101063108/169711665-efbb674e-97e7-473a-b507-f9481fd2a155.png)

* ![image](https://user-images.githubusercontent.com/101063108/169711670-2f3d20d6-2027-49a8-94fc-c5e10c8c8c1a.png)
: 강도가 a인 image A의 voxel의 수

* ![image](https://user-images.githubusercontent.com/101063108/169711700-4767c0f2-253a-4c0b-91d4-7d00cd20bc52.png)
and ![image](https://user-images.githubusercontent.com/101063108/169711713-d0afd6a2-f3c8-44c6-8d16-60b1afb40e8f.png)
: A의 파티션 a에 강도가 있는 voxel과 함께 발생하는 이미지 B'의 voxel의 평균 및 표준편차

* N : ![image](https://user-images.githubusercontent.com/101063108/169711736-2b044f80-c4b2-4096-aec9-1e5fb9520cad.png)
의 voxel의 수

A <-> B / a <-> b 이어도 VIR 대체값 계산 가능.

VIR 값은 다르고, VIR 측정 선택 application에 따라 다르다.

Intramodality registration : 각 파티션은 하나의 강도 값으로 구성

MR-PET registration : 256개의 intensivity 파티션

### 8.5.1.4. Joint histograms and joint probability distributions







